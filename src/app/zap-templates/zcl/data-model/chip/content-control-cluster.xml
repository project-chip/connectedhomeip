<?xml version="1.0"?>
<!--
Copyright (c) 2023 Project CHIP Authors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<configurator>
  <domain name="CHIP"/>
  <bitmap name="DayOfWeekBitmap" type="bitmap8">
    <cluster code="0x050F"/>
    <field name="Sunday" mask="0x01"/>
    <field name="Monday" mask="0x02"/>
    <field name="Tuesday" mask="0x04"/>
    <field name="Wednesday" mask="0x08"/>
    <field name="Thursday" mask="0x10"/>
    <field name="Friday" mask="0x20"/>
    <field name="Saturday" mask="0x40"/>
  </bitmap>
  <cluster apiMaturity="provisional">
    <domain>Media</domain>
    <name>Content Control</name>
    <code>0x050F</code>
    <define>CONTENT_CONTROL_CLUSTER</define>
    <client init="false" tick="false">true</client>
    <server init="false" tick="false">true</server>
    <description>This cluster is used for managing the content control (including "parental control") settings on a media device such as a TV, or Set-top Box.</description>

    <globalAttribute code="0xFFFD" side="either" value="1"/>
    <features>
      <feature bit="0" code="ST" name="ScreenTime" summary="Supports managing screen time limits.">
        <optionalConform/>
      </feature>
      <feature bit="1" code="PM" name="PINManagement" summary="Supports managing a PIN code which is used for restricting access to configuration of this feature.">
        <optionalConform/>
      </feature>
      <feature bit="2" code="BU" name="BlockUnrated" summary="Supports managing content controls for unrated content.">
        <optionalConform/>
      </feature>
      <feature bit="3" code="OCR" name="OnDemandContentRating" summary="Supports managing content controls based upon rating threshold for on demand content.">
        <optionalConform/>
      </feature>
      <feature bit="4" code="SCR" name="ScheduledContentRating" summary="Supports managing content controls based upon rating threshold for scheduled content.">
        <optionalConform/>
      </feature>
    </features>

    <attribute side="server" code="0x0000" define="ENABLED" type="boolean" writable="false" optional="false">Enabled</attribute>
    <attribute side="server" code="0x0001" define="ON_DEMAND_RATINGS" type="ARRAY" entryType="RatingNameStruct" writable="false" optional="true">OnDemandRatings</attribute>
    <attribute side="server" code="0x0002" define="ON_DEMAND_THRESHOLD" type="char_string" length="8" writable="false" optional="true">OnDemandRatingThreshold</attribute>
    <attribute side="server" code="0x0003" define="SCHEDULED_CONTENT_RATINGS" type="ARRAY" entryType="RatingNameStruct" writable="false" optional="true">ScheduledContentRatings</attribute>
    <attribute side="server" code="0x0004" define="SCHEDULED_CONTENT_RATING_THRESHOLD" type="char_string" length="8" writable="false" optional="true">ScheduledContentRatingThreshold</attribute>
    <attribute side="server" code="0x0005" define="SCREEN_DAILY_TIME" type="elapsed_s" optional="true" max="86400">ScreenDailyTime</attribute>
    <attribute side="server" code="0x0006" define="REMAINING_SCREEN_TIME" type="elapsed_s" optional="true" max="86400">RemainingScreenTime</attribute>
    <attribute side="server" code="0x0007" define="BLOCK_UNRATED" type="boolean" optional="true">BlockUnrated</attribute>
    <attribute side="server" code="0x0008" define="BLOCK_CHANNEL_LIST" type="array" entryType="BlockChannelStruct" optional="true">BlockChannelList</attribute>
    <attribute side="server" code="0x0009" define="BLOCK_APPLICATION_LIST" type="array" entryType="AppInfoStruct" optional="true">BlockApplicationList</attribute>
    <attribute side="server" code="0x000A" define="BLOCK_CONTENT_TIME_WINDOW" type="array" entryType="TimeWindowStruct" length="7" optional="true">BlockContentTimeWindow</attribute>

    <command source="client" code="0x00" name="UpdatePIN" optional="true" mustUseTimedInvoke="true">
      <description>The purpose of this command is to update the PIN used for protecting configuration of the content control settings. Upon success, the old PIN SHALL no longer work. The PIN is used to ensure that only the Node (or User) with the PIN code can make changes to the Content Control settings, for example, turn off Content Controls or modify the ScreenDailyTime. The PIN is composed of a numeric string of up to 6 human readable characters (displayable) . Upon receipt of this command, the media device SHALL check if the OldPIN field of this command is the same as the current PIN. If the PINs are the same, then the PIN code SHALL be set to NewPIN. Otherwise a response with InvalidPINCode error status SHALL be returned. The media device MAY provide a default PIN to the User via an out of band mechanism. For security reasons, it is recommended that a client encourage the user to update the PIN from its default value when performing configuration of the Content Control settings exposed by this cluster. The ResetPIN command can also be used to obtain the default PIN.</description>
      <arg id="0" name="OldPIN" type="char_string" length="6"/>
      <arg id="1" name="NewPIN" type="char_string" length="6"/>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x01" name="ResetPIN" response="ResetPINResponse" optional="true" mustUseTimedInvoke="true">
      <description>The purpose of this command is to reset the PIN. If this command is executed successfully, a ResetPINResponse command with a new PIN SHALL be returned.</description>
      <access op="invoke" privilege="administer"/>
    </command>

    <command source="server" code="0x02" name="ResetPINResponse" optional="true" disableDefaultResponse="true">
      <description>This command SHALL be generated in response to a ResetPIN command. The data for this command SHALL be as follows:</description>
      <arg name="PINCode" type="char_string" max="6" optional="false"/>
    </command>

    <command source="client" code="0x03" name="Enable" optional="false" mustUseTimedInvoke="true">
      <description>The purpose of this command is to turn on the Content Control feature on a media device. On receipt of the Enable command, the media device SHALL set the Enabled attribute to TRUE.</description>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x04" name="Disable" optional="false" mustUseTimedInvoke="true">
      <description>The purpose of this command is to turn off the Content Control feature on a media device. On receipt of the Disable command, the media device SHALL set the Enabled attribute to FALSE.</description>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x05" name="AddBonusTime" optional="true">
      <description>The purpose of this command is to add the extra screen time for the user. If a client with Operate privilege invokes this command, the media device SHALL check whether the PINCode passed in the command matches the current PINCode value. If these match, then the RemainingScreenTime attribute SHALL be increased by the specified BonusTime value. If the PINs do not match, then a response with InvalidPINCode error status SHALL be returned, and no changes SHALL be made to RemainingScreenTime. If a client with Manage privilege or greater invokes this command, the media device SHALL ignore the PINCode field and directly increase the RemainingScreenTime attribute by the specified BonusTime value. A server that does not support the PM feature SHALL respond with InvalidPINCode to clients that only have Operate privilege unless: It has been provided with the PIN value to expect via an out of band mechanism, and The client has provided a PINCode that matches the expected PIN value.</description>
      <arg id="0" name="PINCode" type="char_string" optional="true" length="6"/>
      <arg id="1" name="BonusTime" type="elapsed_s"/>
    </command>

    <command source="client" code="0x06" name="SetScreenDailyTime" optional="true">
      <description>The purpose of this command is to set the ScreenDailyTime attribute. On receipt of the SetScreenDailyTime command, the media device SHALL set the ScreenDailyTime attribute to the ScreenTime value.</description>
      <arg id="0" name="ScreenTime" type="elapsed_s" max="86400"/>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x07" name="BlockUnratedContent" optional="true">
      <description>The purpose of this command is to specify whether programs with no Content rating must be blocked by this media device. On receipt of the BlockUnratedContent command, the media device SHALL set the BlockUnrated attribute to TRUE.</description>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x08" name="UnblockUnratedContent" optional="true">
      <description>The purpose of this command is to specify whether programs with no Content rating must be blocked by this media device. On receipt of the UnblockUnratedContent command, the media device SHALL set the BlockUnrated attribute to FALSE.</description>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x09" name="SetOnDemandRatingThreshold" optional="true">
      <description>The purpose of this command is to set the OnDemandRatingThreshold attribute. On receipt of the SetOnDemandRatingThreshold command, the media device SHALL check if the Rating field is one of values present in the OnDemandRatings attribute. If not, then a response with InvalidRating error status SHALL be returned.</description>
      <arg id="0" name="Rating" type="char_string" length="8"/>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x0A" name="SetScheduledContentRatingThreshold" optional="true">
      <description>The purpose of this command is to set ScheduledContentRatingThreshold attribute. On receipt of the SetScheduledContentRatingThreshold command, the media device SHALL check if the Rating field is one of values present in the ScheduledContentRatings attribute. If not, then a response with InvalidRating error status SHALL be returned.</description>
      <arg id="0" name="Rating" type="char_string" length="8"/>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x0B" name="AddBlockChannels" optional="true">
      <description>The purpose of this command is to set BlockChannelList attribute.</description>
      <arg id="0" name="Channels" array="true" type="BlockChannelStruct"/>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x0C" name="RemoveBlockChannels" optional="true">
      <description>The purpose of this command is to remove channels from the BlockChannelList attribute.</description>
      <arg id="0" name="ChannelIndexes" array="true" type="int16u"/>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x0D" name="AddBlockApplications" optional="true">
      <description>The purpose of this command is to set applications to the BlockApplicationList attribute.</description>
      <arg id="0" name="Applications" array="true" type="AppInfoStruct"/>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x0E" name="RemoveBlockApplications" optional="true">
      <description>The purpose of this command is to remove applications from the BlockApplicationList attribute.</description>
      <arg id="0" name="Applications" array="true" type="AppInfoStruct"/>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x0F" name="SetBlockContentTimeWindow" optional="true">
      <description>The purpose of this command is to set the BlockContentTimeWindow attribute.</description>
      <arg id="0" name="TimeWindow" type="TimeWindowStruct"/>
      <access op="invoke" privilege="manage"/>
    </command>

    <command source="client" code="0x10" name="RemoveBlockContentTimeWindow" optional="true">
      <description>The purpose of this command is to remove the selected time windows from the BlockContentTimeWindow attribute.</description>
      <arg id="0" name="TimeWindowIndexes" array="true" type="int16u"/>
      <access op="invoke" privilege="manage"/>
    </command>

    <event side="server" code="0x00" priority="info" name="RemainingScreenTimeExpired" optional="true">
      <description>This event SHALL be generated when the RemainingScreenTime equals 0.</description>
    </event>

    <event side="server" code="0x01" priority="info" name="EnteringBlockContentTimeWindow" optional="true">
      <description>This event SHALL be generated when entering a period of blocked content as configured in the BlockContentTimeWindow attribute.</description>
    </event>
  </cluster>

  <struct name="AppInfoStruct" apiMaturity="provisional">
    <cluster code="0x050F"/>
    <item fieldId="0" name="CatalogVendorID" type="int16u"/>
    <item fieldId="1" name="ApplicationID" type="char_string"/>
  </struct>

  <struct name="BlockChannelStruct" apiMaturity="provisional">
    <cluster code="0x050F"/>
    <item fieldId="0" name="BlockChannelIndex" type="int16u" isNullable="true"/>
    <item fieldId="1" name="MajorNumber" type="int16u"/>
    <item fieldId="2" name="MinorNumber" type="int16u"/>
    <item fieldId="3" name="Identifier" type="char_string" optional="true"/>
  </struct>

  <struct name="RatingNameStruct">
    <cluster code="0x050F"/>
    <item fieldId="0" name="RatingName" type="char_string" length="8"/>
    <item fieldId="1" name="RatingNameDesc" type="char_string" optional="true" length="64"/>
  </struct>

  <struct name="TimePeriodStruct" apiMaturity="provisional">
    <cluster code="0x050F"/>
    <item fieldId="0" name="StartHour" type="int8u" min="0" max="23"/>
    <item fieldId="1" name="StartMinute" type="int8u" min="0" max="59"/>
    <item fieldId="2" name="EndHour" type="int8u" min="0" max="23"/>
    <item fieldId="3" name="EndMinute" type="int8u" min="0" max="59"/>
  </struct>

  <struct name="TimeWindowStruct" apiMaturity="provisional">
    <cluster code="0x050F"/>
    <item fieldId="0" name="TimeWindowIndex" type="int16u" isNullable="true"/>
    <item fieldId="1" name="DayOfWeek" type="DayOfWeekBitmap" min="0x00" max="0x7F"/>
    <item fieldId="2" name="TimePeriod" array="true" type="TimePeriodStruct"/>
  </struct>
</configurator>
