# Copyright (c) 2021 Project CHIP Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name:
    22.1.5. [TC-MF-1.5] Commissioning window handling timeout and revocation
    using ECM [DUT_CE - Commissionee]

config:
    nodeId: 0x12344321
    cluster: "Basic"
    endpoint: 0

tests:
    - label: "TH_CR1 starts a commissioning process with DUT_CE"
      verification:
          "1. Provision the device using first python controller on the raspi
          (use above instructions)"
      disabled: true

    - label:
          "TH_CR1 opens a commissioning window on DUT_CE using a commissioning
          timeout of PIXIT_COMM_WIN seconds using ECM"
      verification:
          "On 1st controller using chip-tool, send the open-commissioning-window
          CMD for ECM. -t stands for timeout value, -o for
          OriginalSetupCode/TokenWithRandomPIN/TokenWithProvidedPIN , -d for
          descriminator -i for iteration count. Ref to cmd help. ./chip-tool
          pairing open-commissioning-window 1 1 200 1000 3840
          [1635864513.699433][3850:3855] CHIP:DMG: ICR moving to [CommandSen]
          [1635864513.699489][3850:3855] CHIP:CTL: Manual pairing code:
          [36177160937] [1635864513.699566][3850:3855] CHIP:CTL: SetupQRCode:
          [MT:00000CQM00YZN476420] [1635864513.699636][3850:3855] CHIP:EM:
          Sending Standalone Ack for MessageCounter:2599714227 on exchange
          60688i [1635864513.699685][3850:3855] CHIP:IN: Prepared plaintext
          message 0xffff8a7cd960 to 0x0000000000000000 of type 0x10 and
          protocolId (0, 0) on exchange 60688i with MessageCounter:3019982536.
          [1635864513.699737][3850:3855] CHIP:IN: Sending plaintext msg
          0xffff8a7cd960 with MessageCounter:3019982536 to 0x0000000000000000 at
          monotonic time: 6085358 msec [1635864513.699834][3850:3855] CHIP:EM:
          Flushed pending ack for MessageCounter:2599714227 on exchange 60688i
          The setup pin code is extracted from the manual pairing code in the
          log and that will be used when pairing the 2nd admin controller."
      disabled: true

    - label:
          "TH_CR2 starts a commissioning process with DUT_CE after
          PIXIT_COMM_WIN + 10 seconds"
      verification:
          "1. On 2nd controller using chip-tool connect using manual code
          generated by 1st controller. Below is the example when using chip tool
          as controller (considering 36177160937 as the manual code generated by
          1st controller) ./chip-tool pairing manualcode 1 36177160937"
      disabled: true

    - label:
          "TH_CR1 opens a new commissioning window on DUT_CE using a
          commissioning timeout of PIXIT_COMM_WIN seconds using ECM"
      verification:
          "On 1st controller using chip-tool, send the open-commissioning-window
          CMD for ECM. -t stands for timeout value, -o for
          OriginalSetupCode/TokenWithRandomPIN/TokenWithProvidedPIN , -d for
          descriminator -i for iteration count. Ref to cmd help. ./chip-tool
          pairing open-commissioning-window 1 1 200 1000 3840
          [1635864513.699433][3850:3855] CHIP:DMG: ICR moving to [CommandSen]
          [1635864513.699489][3850:3855] CHIP:CTL: Manual pairing code:
          [36177160937] [1635864513.699566][3850:3855] CHIP:CTL: SetupQRCode:
          [MT:00000CQM00YZN476420] [1635864513.699636][3850:3855] CHIP:EM:
          Sending Standalone Ack for MessageCounter:2599714227 on exchange
          60688i [1635864513.699685][3850:3855] CHIP:IN: Prepared plaintext
          message 0xffff8a7cd960 to 0x0000000000000000 of type 0x10 and
          protocolId (0, 0) on exchange 60688i with MessageCounter:3019982536.
          [1635864513.699737][3850:3855] CHIP:IN: Sending plaintext msg
          0xffff8a7cd960 with MessageCounter:3019982536 to 0x0000000000000000 at
          monotonic time: 6085358 msec [1635864513.699834][3850:3855] CHIP:EM:
          Flushed pending ack for MessageCounter:2599714227 on exchange 60688i
          The setup pin code is extracted from the manual pairing code in the
          log and that will be used when pairing the 2nd admin controller."
      disabled: true

    - label:
          "TH_CR1 revokes the commissioning window on DUT_CE using
          RevokeCommissioning command"
      verification:
          "On 1st controller using chip tool, send revoke commissioning command
          to DUT_CE ./chip-tool administratorcommissioning revoke-commissioning
          1 0 [1635866684.242002][4030:4035] CHIP:DMG: InvokeCommand =
          [1635866684.242033][4030:4035] CHIP:DMG: {
          [1635866684.242059][4030:4035] CHIP:DMG: CommandList =
          [1635866684.242091][4030:4035] CHIP:DMG: [
          [1635866684.242122][4030:4035] CHIP:DMG: CommandDataIB =
          [1635866684.242156][4030:4035] CHIP:DMG: {
          [1635866684.242188][4030:4035] CHIP:DMG: CommandPathIB =
          [1635866684.242225][4030:4035] CHIP:DMG: {
          [1635866684.242262][4030:4035] CHIP:DMG: EndpointId = 0x0,
          [1635866684.242300][4030:4035] CHIP:DMG: ClusterId = 0x3c,
          [1635866684.242339][4030:4035] CHIP:DMG: CommandId = 0x2,
          [1635866684.242375][4030:4035] CHIP:DMG: },
          [1635866684.242415][4030:4035] CHIP:DMG:
          [1635866684.242447][4030:4035] CHIP:DMG: StatusIB =
          [1635866684.242496][4030:4035] CHIP:DMG: {
          [1635866684.242547][4030:4035] CHIP:DMG: status = 0x0,
          [1635866684.242594][4030:4035] CHIP:DMG: },
          [1635866684.242663][4030:4035] CHIP:DMG:
          [1635866684.242700][4030:4035] CHIP:DMG: },
          [1635866684.242746][4030:4035] CHIP:DMG:
          [1635866684.242781][4030:4035] CHIP:DMG: ],
          [1635866684.242824][4030:4035] CHIP:DMG:
          [1635866684.242857][4030:4035] CHIP:DMG: }
          [1635866684.242915][4030:4035] CHIP:DMG: Received Command Response
          Status for Endpoint=0 Cluster=0x0000_003C Command=0x0000_0002
          Status=0x0 [1635866684.242956][4030:4035] CHIP:TOO: Default Success
          Response"
      disabled: true

    - label: "TH_CR2 starts a commissioning process with DUT_CE"
      verification:
          "1. On 2nd controller using chip-tool connect using manual code
          generated by 1st controller. Below is the example when using chip tool
          as controller (considering 36177160937 as the manual code generated by
          1st controller) ./chip-tool pairing manualcode 1 36177160937"
      disabled: true

    - label:
          "TH_CR1 revokes the commissioning window on DUT_CE using
          RevokeCommissioning command"
      verification:
          "On 1st controller using chip tool, send revoke commissioning command
          to DUT_CE ./chip-tool administratorcommissioning revoke-commissioning
          1 0 [1635867701.392315][4074:4079] CHIP:DMG: InvokeCommand =
          [1635867701.392357][4074:4079] CHIP:DMG: {
          [1635867701.392389][4074:4079] CHIP:DMG: CommandList =
          [1635867701.392427][4074:4079] CHIP:DMG: [
          [1635867701.392463][4074:4079] CHIP:DMG: CommandDataIB =
          [1635867701.392535][4074:4079] CHIP:DMG: {
          [1635867701.392593][4074:4079] CHIP:DMG: CommandPathIB =
          [1635867701.392664][4074:4079] CHIP:DMG: {
          [1635867701.392723][4074:4079] CHIP:DMG: EndpointId = 0x0,
          [1635867701.392777][4074:4079] CHIP:DMG: ClusterId = 0x3c,
          [1635867701.392877][4074:4079] CHIP:DMG: CommandId = 0x2,
          [1635867701.393046][4074:4079] CHIP:DMG: },
          [1635867701.393108][4074:4079] CHIP:DMG:
          [1635867701.393149][4074:4079] CHIP:DMG: StatusIB =
          [1635867701.393214][4074:4079] CHIP:DMG: {
          [1635867701.393253][4074:4079] CHIP:DMG: status = 0x0,
          [1635867701.393316][4074:4079] CHIP:DMG: },
          [1635867701.393378][4074:4079] CHIP:DMG:
          [1635867701.393444][4074:4079] CHIP:DMG: },
          [1635867701.393510][4074:4079] CHIP:DMG:
          [1635867701.393548][4074:4079] CHIP:DMG: ],
          [1635867701.393612][4074:4079] CHIP:DMG:
          [1635867701.393649][4074:4079] CHIP:DMG: }
          [1635867701.393706][4074:4079] CHIP:DMG: Received Command Response
          Status for Endpoint=0 Cluster=0x0000_003C Command=0x0000_0002
          Status=0x0 [1635867701.393751][4074:4079] CHIP:TOO: Default Success
          Response"
      disabled: true

    - label:
          "TH_CR1 writes and reads the Basic Information Clusters NodeLabel
          mandatory attribute of DUT_CE"
      verification:
          "On 1st controller, using chip tool, write and read Basic Information
          Clusters NodeLabel mandatory attribute of DUT_CE ./chip-tool basic
          write user-label te5new 1 0 [1635867759.827129][4081:4086] CHIP:DMG:
          WriteResponse = [1635867759.827159][4081:4086] CHIP:DMG: {
          [1635867759.827186][4081:4086] CHIP:DMG: AttributeStatusList =
          [1635867759.827221][4081:4086] CHIP:DMG: [
          [1635867759.827253][4081:4086] CHIP:DMG: AttributeStatusIB =
          [1635867759.827291][4081:4086] CHIP:DMG: {
          [1635867759.827325][4081:4086] CHIP:DMG: AttributePath =
          [1635867759.827387][4081:4086] CHIP:DMG: {
          [1635867759.827446][4081:4086] CHIP:DMG: FieldTag = 0x0000_0005,
          [1635867759.827491][4081:4086] CHIP:DMG: NodeId = 0x0,
          [1635867759.827554][4081:4086] CHIP:DMG: ClusterId = 0x28,
          [1635867759.827616][4081:4086] CHIP:DMG: EndpointId = 0x0,
          [1635867759.827655][4081:4086] CHIP:DMG: }
          [1635867759.827716][4081:4086] CHIP:DMG:
          [1635867759.827759][4081:4086] CHIP:DMG: StatusIB =
          [1635867759.827828][4081:4086] CHIP:DMG: {
          [1635867759.827866][4081:4086] CHIP:DMG: status = 0x0,
          [1635867759.827924][4081:4086] CHIP:DMG: },
          [1635867759.827980][4081:4086] CHIP:DMG:
          [1635867759.828017][4081:4086] CHIP:DMG: },
          [1635867759.828059][4081:4086] CHIP:DMG:
          [1635867759.828092][4081:4086] CHIP:DMG: ],
          [1635867759.828131][4081:4086] CHIP:DMG:
          [1635867759.828161][4081:4086] CHIP:DMG: }
          [1635867759.828250][4081:4086] CHIP:ZCL: WriteResponse:
          [1635867759.828299][4081:4086] CHIP:ZCL: status: Success (0x0000)
          [1635867759.828334][4081:4086] CHIP:TOO: Default Success Response
          ./chip-tool basic read user-label 1 0 [1635867798.990540][4089:4094]
          CHIP:DMG: { [1635867798.990575][4089:4094] CHIP:DMG: AttributeDataList
          = [1635867798.990614][4089:4094] CHIP:DMG: [
          [1635867798.990651][4089:4094] CHIP:DMG: AttributeDataElement =
          [1635867798.990698][4089:4094] CHIP:DMG: {
          [1635867798.990741][4089:4094] CHIP:DMG: AttributePath =
          [1635867798.990783][4089:4094] CHIP:DMG: {
          [1635867798.990840][4089:4094] CHIP:DMG: NodeId = 0x1,
          [1635867798.990883][4089:4094] CHIP:DMG: EndpointId = 0x0,
          [1635867798.990949][4089:4094] CHIP:DMG: ClusterId = 0x28,
          [1635867798.991022][4089:4094] CHIP:DMG: FieldTag = 0x0000_0005,
          [1635867798.991083][4089:4094] CHIP:DMG: }
          [1635867798.991164][4089:4094] CHIP:DMG:
          [1635867798.991225][4089:4094] CHIP:DMG: Data = 'te5new',
          [1635867798.991280][4089:4094] CHIP:DMG: DataElementVersion = 0x0,
          [1635867798.991338][4089:4094] CHIP:DMG: },
          [1635867798.991407][4089:4094] CHIP:DMG:
          [1635867798.991459][4089:4094] CHIP:DMG: ],
          [1635867798.991521][4089:4094] CHIP:DMG:
          [1635867798.991569][4089:4094] CHIP:DMG: }
          [1635867798.991711][4089:4094] CHIP:ZCL: ReadAttributesResponse:
          [1635867798.991758][4089:4094] CHIP:ZCL: ClusterId: 0x0000_0028
          [1635867798.991809][4089:4094] CHIP:ZCL: attributeId: 0x0000_0005
          [1635867798.991856][4089:4094] CHIP:ZCL: status: Success (0x0000)
          [1635867798.991901][4089:4094] CHIP:ZCL: attribute TLV Type: 0x0c
          [1635867798.991953][4089:4094] CHIP:TOO: CharString attribute
          Response: te5new"
      disabled: true

    - label:
          "TH_CR1 opens a new commissioning window on DUT_CE using a
          commissioning timeout of PIXIT_COMM_WIN seconds using ECM"
      verification:
          "On 1st controller using chip-tool, send the open-commissioning-window
          CMD for ECM. -t stands for timeout value, -o for
          OriginalSetupCode/TokenWithRandomPIN/TokenWithProvidedPIN , -d for
          descriminator -i for iteration count. Ref to cmd help. ./chip-tool
          pairing open-commissioning-window 1 1 200 1000 3840
          [1635864513.699433][3850:3855] CHIP:DMG: ICR moving to [CommandSen]
          [1635864513.699489][3850:3855] CHIP:CTL: Manual pairing code:
          [36177160937] [1635864513.699566][3850:3855] CHIP:CTL: SetupQRCode:
          [MT:00000CQM00YZN476420] [1635864513.699636][3850:3855] CHIP:EM:
          Sending Standalone Ack for MessageCounter:2599714227 on exchange
          60688i [1635864513.699685][3850:3855] CHIP:IN: Prepared plaintext
          message 0xffff8a7cd960 to 0x0000000000000000 of type 0x10 and
          protocolId (0, 0) on exchange 60688i with MessageCounter:3019982536.
          [1635864513.699737][3850:3855] CHIP:IN: Sending plaintext msg
          0xffff8a7cd960 with MessageCounter:3019982536 to 0x0000000000000000 at
          monotonic time: 6085358 msec [1635864513.699834][3850:3855] CHIP:EM:
          Flushed pending ack for MessageCounter:2599714227 on exchange 60688i
          The setup pin code is extracted from the manual pairing code in the
          log and that will be used when pairing the 2nd admin controller."
      disabled: true

    - label: "TH_CR2 starts a commissioning process with DUT_CE"
      verification:
          "1. On 2nd controller using chip-tool connect using manual code
          generated by 1st controller. Below is the example when using chip tool
          as controller (considering 36177160937 as the manual code generated by
          1st controller) ./chip-tool pairing manualcode 1 36177160937"
      disabled: true

    - label: "TH_CR3 starts a commissioning process with DUT_CE"
      verification:
          "1. On 3rd controller using chip-tool connect using manual code
          generated by 1st controller. Below is the example when using chip tool
          as controller (considering 36177160937 as the manual code generated by
          1st controller) ./chip-tool pairing manualcode 1 36177160937"
      disabled: true
