# Interoperability Debugging Tool

## Overview

The “Interoperability Debugging Tool” (IDT) is a python-based tool that supports
a variety of commands that are useful in the context of interoperability testing
of Matter devices and app controllers.

### Discovery

While in discovery mode, the tool displays all Matter devices that are in
commission and/or operational mode. This is useful to have a clear understanding
of all Matter devices currently “active” in the testing environment.

See section “4.3. Discovery” of the Matter spec for official documentation.

When run interactively, discovery functions in one of two modes: BLE and DNS-SD.

### Capture

While in capture mode, the tool starts capturing all data of interest (e.g.
video recording of interactions with the mobile app, logs from all components
involved, network packets capture, etc.) while a test is being conducted
manually. It also provides feedback to the user on test setup and execution.

When the test completes, capture mode is stopped and all captured data is zipped
in a file that can then be sent to all parties involved in investigating any
issue uncovered via the manual test. Each ecosystem may implement an analysis
that analyzes capture data, displays info to the user, probes the local
environment and generates additional artifacts.

### Other functions

#### Advertise

Create fake advertisements for Matter devices, useful in controller testing.

#### Probe

Collect basic networking info from the environment, e.g. resolve and ping all
matter devices.

#### Setup

Provides ready-made setup scripts for specific, one-time build / installation
tasks, e.g. setting up a development kit as a thread sniffer.

## Single host installation (no Raspberry Pi)

`idt` can be run on both macOS and Linux (tested with Debian based systems).  
See the feature map section at the bottom of this page for details on feature
support by host platform.

If you prefer to execute capture and discovery from a Raspberry Pi, read the
next section instead.

The machine running `idt` should be connected to the same Wi-Fi network used for
testing.  
Follow the steps below to execute capture and discovery without a Raspberry Pi:

-   From the parent directory of `idt`, run `source idt/scripts/alias.sh`.
-   Optionally, run `source idt/scripts/setup_shell.sh` to install aliases
    permanently.
-   After `idt` aliases are available in your environment, calling any `idt`
    command will automatically create a new virtual environment and install
    python dependencies.
    -   If you're missing non-Python dependencies, you'll be prompted to install
        them until they're available.
-   Bluetooth discovery on macOS will require granting the program where `idt`
    is run, e.g. terminal emulator or IDE permission to access bluetooth in
    macOS settings.
    -   Failure to do so may result in any of the following:
        -   A single `abort` message and no further output in the terminal.
        -   Failure with a relevant stack trace in the terminal.
        -   A prompt to allow the application access to bluetooth.

## Thread

Thread captures require a compatible development kit. The thread implementation
in this tool currently targets the `Maker Diary nrf52840 Micro Development Kit`
(NOT the dongle version).

## Raspberry Pi installation

### Environment overview

The execution environment of IDT when using Raspberry Pi is shown in the figure
below.

[TODO] add figure.

The Raspberry Pi is where "discovery" and "capture" are executed.

The "admin" computer is the machine used to connect to and control the RPi, and
to fetch artifacts which were created during capture from the RPi.

This directory contains tools for use on both the admin computer and the RPi.

### Environment details

1. `idt` will be used on both the admin computer and the RPi.
1. `scripts` only points to one installation location at a time. It is ideal to
   maintain a single `idt` directory on each (admin and RPi) system accordingly.
1. The expected install location on the RPi is the home directory of the user
   specified in `idt/scripts/vars.sh`, which will be generated by running a
   script in the next section.
1. Helper scripts may be used on admin computers that support `zsh` and `bash`
   (Linux and macOS).
1. Windows may be used as the admin computer via tools like `PowerShell`,
   `MobaXterm` and `FileZilla`.
1. This setup is intended to work with the admin computer and RPi connected to
   the same Wi-Fi network, which is also the Wi-Fi network used for testing.
1. Corporate networks are not expected to be used as test networks.

### Prepare the RPi

1. A >= 128 GB SD card is recommended.
1. Flash the RPi SD with the debian based distribution of your choice.
1. Plug the SD into the RPi.
1. Ensure the RPi is connected to your network, either via ethernet or with
   Wi-Fi configured in the disk image.
1. Boot the RPi.

### Configure admin computer and push to the RPi

#### Linux and macOS admin computers

1. On your admin computer, source the `alias` script from the parent directory
   of `idt` to get `idt` commands in your current shell.
    ```
     source idt/scripts/alias.sh
    ```
    - To avoid having to repeat this step for each session, optionally configure
      automatic aliases permanently.
    - **_NOTE:_** Once run, `idt` commands will be globally and automatically
      available. If you need to remove the installation, edit the `.rc` files
      mentioned in `setup_shell`.
    ```
    source idt/scripts/setup_shell.sh
    ```
1. Run `idt_create_vars` and follow the prompts to set IDs for the target RPi.
1. Send `idt` to the RPi:
    ```
    idt_push
    ```
1. `ssh` to the RPi:
    - **_NOTE:_** You may need to wait a few minutes after boot for the `ssh`
      server to be available on the RPi. Retry if needed!
    ```
    idt_connect
    ```

#### Windows admin computers

1. Open `PowerShell`, cd to the directory containing `idt` and send `idt` to the
   RPi:
    ```
    scp -r ./idt/* $PIUSER@$PIHOST:/home/$PIUSER/idt
    ```
1. `ssh` to the RPi, e.g. with `MobaXterm`
    - **_NOTE:_** You may need to wait a few minutes after boot for the `ssh`
      server to be available on the RPi. Retry if needed!
    - Use `$PIUSER@$PIHOST` or `$PIUSER@$ip` where `$ip` is the RPi's IP found
      in your router admin panel.

### Configure the RPi

1. Configure passwords or ssh keys.
1. Configure Wi-Fi networks if needed.
1. Set up `idt`:
    ```
    cd ~                               # Go to idt parent dir
    source idt/scripts/setup_shell.sh  # Setup atuo aliases
    source idt/scripts/alias.sh        # Get aliases now
    ```

[TODO] Drop docker and audit native installation instructions

## User guide

> **_IMPORTANT_**  
> `idt_` commands are shell aliases helpful for administrative commands.  
> `idt` invokes the `idt` python package.
>
> Output from `idt` will generally be colorized while output from sub processes
> is generally not.
>
> Each command will produce artifacts in a new directory within
> `idt/IDT_ARTIFACTS` and display the archive path at the end of execution.

RPi users, as needed:

-   For users with Windows admin computers, reconnect e.g., using `MobaXterm`
-   Other users reconnect `ssh` to the RPi (from your admin computer):
    ```
    idt_connect
    ```

### Capture

> **_IMPORTANT_**  
> Ensure you've made it to the log line "Starting real time analysis, press
> enter to stop!" before launching the app under test.

```
usage: idt capture [-h] [--platform {Android}] [--ecosystem {PlayServices,PlayServicesUser,ALL}] [--pcap {t,f}] [--interface {any}] [--monitor {t,f}] [--channel CHANNEL] [--band {2,5}] [--width WIDTH] [--thread {none,sniff,on_network}]

options:
  -h, --help            show this help message and exit
  --platform {Android}, -p {Android}
                        Run capture for a particular platform (default Android)
  --ecosystem {PlayServices,PlayServicesUser,ALL}, -e {PlayServices,PlayServicesUser,ALL}
                        Run capture for a particular ecosystem or ALL ecosystems (default ALL)
  --pcap {t,f}, -c {t,f}
                        Run packet capture (default t)
  --interface {any}, -i {any}
                        Specify packet capture interface (default any)
  --monitor {t,f}, -m {t,f}
                        Run packet capture using a monitor mode interface (default f)
  --channel CHANNEL, -n CHANNEL
                        Use this Wi-Fi channel if in monitor mode (default 1)
  --band {2,5}, -b {2,5}
                        Use 2 for 2.4GHz, 5 for 5GHz (default 2)
  --width WIDTH, -w WIDTH
                        Optionally set the channel width of a monitor mode pcap (default None)
  --thread {none,sniff,on_network}, -t {none,sniff,on_network}
                        Execute thread sniffer or join OTBR to network (Default none)
```

For packet capture interface (`-i`/`--interface`:

-   On macOS, the only available interface is `any`.
-   On Linux, `idt` checks available interfaces from `/sys/class/net/` as well
    as allowing `any`.

### Discovery

```
usage: idt discover [-h] --type {ble,b,dnssd,d} [--vid VID] [--pid PID] [--v4 {t,f}] [--v6 {t,f}]

options:
  -h, --help            show this help message and exit
  --type {ble,b,dnssd,d}, -t {ble,b,dnssd,d}
                        Specify the type of discovery to execute
  --vid VID, -v VID     Only display advertisements with this Vendor ID. Hex values (without 0x prefix) are expected. Eg FFF1
  --pid PID, -p PID     If vid argument is set, filter advertisements by this Product ID as well. Hex values (without 0x prefix) are expected. Eg 8000
  --v4 {t,f}, -4 {t,f}  Whether to browse on IPv4 or not (Default t)
  --v6 {t,f}, -6 {t,f}  Whether to browse on IPv6 or not (Default t)
```

### Advertise

```
usage: idt advertise [-h] [--vid VID] [--pid PID] [--discriminator DISCRIMINATOR] [--device_name DEVICE_NAME] [--device_type {256,257,268,269,266,267,771,259,260,261,2112,772,15,21,262,263,770,773,774,775,2128,10,11,514,515,768,769,43,40,35,34,36,41,42,39}] [--port PORT] [--commissioning_open {t,f}] [--mac_address MAC_ADDRESS] [--allow_gua {t,f}] --type {ble,b,dnssd,d}

options:
  -h, --help            show this help message and exit
  --vid VID, -v VID     Vendor ID to use in the advertisement (int, default: 65521)
  --pid PID, -p PID     Product ID to use in the advertisement (int, default: 32768)
  --discriminator DISCRIMINATOR, -i DISCRIMINATOR
                        Discriminator to use in the advertisement (int, default: 10)
  --device_name DEVICE_NAME, -n DEVICE_NAME
                        Device name to be used in the advertisement (str, default: IDT fake device)
  --device_type {256,257,268,269,266,267,771,259,260,261,2112,772,15,21,262,263,770,773,774,775,2128,10,11,514,515,768,769,43,40,35,34,36,41,42,39}, -d {256,257,268,269,266,267,771,259,260,261,2112,772,15,21,262,263,770,773,774,775,2128,10,11,514,515,768,769,43,40,35,34,36,41,42,39}
                        Device type to be used in the advertisement (int, default: 770)
  --port PORT, -o PORT  The port that this device is reachable on (int, default: 5540)
  --commissioning_open {t,f}, -c {t,f}
                        Whether commissioning window is open or not (default: t)
  --mac_address MAC_ADDRESS, -m MAC_ADDRESS
                        MAC Address to use for the instance name in this advertisement (str, default: A683E7C1029A)
  --allow_gua {t,f}, -g {t,f}
                        Whether DNS-SD advertisements should include GUAs (if they're available on the host)(default: f)
  --type {ble,b,dnssd,d}, -t {ble,b,dnssd,d}
                        Specify the type of advertisement to create
```

### Probe

```
usage: idt probe [-h]

options:
  -h, --help  show this help message and exit
```

### Setup

```
usage: idt setup [-h] --target {Nrf52840MdkNotDongle}

options:
  -h, --help            show this help message and exit
  --target {Nrf52840MdkNotDongle}, -t {Nrf52840MdkNotDongle}
                        The target to setup
```

## Troubleshooting

-   Wireless `adb` may fail to connect indefinitely depending on network
    configuration. Use a wired connection if wireless fails repeatedly.
-   Set `DEBUG=True` in the root `config.py` for additional logging.
-   Compiling `tcpdump` for android may require additional dependencies.
    -   If the build script fails for you, try
        `idt_linux_install_compilers_for_arm_tcpdump`.
-   You may disable colors and splash by setting `ENABLE_COLOR` in `config.py`
    to `False`.
-   `idt_child_kill` will kill any stray `tcpdump` and `adb` commands.
    -   `idt_child_check` will look for leftover processes.
    -   Not expected to be needed outside of development scenarios.

## Project overview

-   The entry point of each feature is in `idt.py` which contains simple CLI
    parsing with `argparse`.

### Features

#### `advertise`

-   `advertise` re-uses the library used in discovery to produce DNS-SD
    advertisements mimicking matter devices.

#### `capture`

-   `base` contains the base classes for ecosystems and platforms.
-   `controller` manages platform and ecosystem implementations at run time.
-   `/platform` and `/ecosystem` contain one package for each platform and
    ecosystem, which should each contain one implementation of the respective
    base class.
-   `pcap` contains the implementation for pcaps on the idt host.
-   `thread` contains the implementation for thread captures on the idt host.

#### `discovery`

-   `ble` provides a simple ble scanner that shows matter devices being
    discovered and lost, as well as their VID/PID, RSSI, etc.
-   `dnssd` provides a simple DNS-SD browser that searches for matter devices
    and thread border routers.

#### `probe`

-   `probe` contains the base class for (`idt`'s) host platform specific
    implementation.
    -   Reuses the dnssd discovery implementation to build probe targets.
    -   Calls platform + addr type specific probe methods for each target.
-   `linux` and `mac` contain `probe` implementations for each host platform.

#### `setup`

-   Contains setup implementations.

### `utils`

-   `host` contains helper functions for interacting with the host running
    `idt`.
-   `analysis` contains utilities for simple causal analysis of text based logs.
-   `artifact` contains helper functions for managing artifacts.
-   `data` contains metadata e.g. matter device type map
-   `error` contains facilities for error reporting.
-   `loader` is a generic class loader that dynamically imports classes matching
    a given super class from a given directory.
-   `log` contains logging utilities.
-   `net` contains utility functions for networking topics like ip addr type.
-   `shell` contains a simple helper class for background and foreground Bash
    commands.

### Conventions

-   List host dependencies and their help text and download links in the
    respective array in the root `config.py`.
-   Users should not need to modify source files as part of any regular
    operation of the tool (e.g. modifying any `config.py` should not be
    required). Use commandline args for runtime options.
-   When needed, execute builds in a folder called `BUILD` within the source
    tree.

## Extending functionality

### Capture

Ecosystem and Platform implementations are dynamically loaded.

For each package in `capture/ecosystem`, the ecosystem loader expects a module
name matching the package name.  
This module must contain a single class which is a subclass of
`capture.base.EcosystemCapture` with matching function signatures.

`/capture/ecosystem/play_services_user` contains a minimal example
implementation.

As another example, link `/res/plugin_demo/ecosystem/demo_ext_ecosystem`.

```
$ idt_go && ln -s $PWD/idt/res/plugin_demo/ecosystem/demo_ext_ecosystem/ idt/capture/ecosystem
$ idt capture -h
usage: idt capture [-h] [--platform {Android}] [--ecosystem {DemoExtEcosystem...
```

> **IMPORTANT:** Note the following runtime expectations of ecosystems:  
> `analyze_capture()` must not block the async event loop excessively and must
> not interact with standard in

The platform loader functions the same as `capture/ecosystem`.

For each package in `capture/platform`, the platform loader expects a module
name matching the package name.  
This module must contain a single class which is a subclass of
`capture.base.PlatformLogStreamer`.

The loader is also used elsewhere in the project.

## Feature map

| Icon               | Meaning              |
| ------------------ | -------------------- |
| :white_check_mark: | Supported            |
| :x:                | Not (/yet) supported |

| Feature   | Function                             | Linux              | MacOS              | Note                  |
| --------- | ------------------------------------ | ------------------ | ------------------ | --------------------- |
| Advertise | DNS-SD                               | :white_check_mark: | :white_check_mark: |                       |
| Advertise | BLE                                  | :x:                | :x:                | Not implemented       |
| Capture   | Android: log collection and analysis | :white_check_mark: | :white_check_mark: |                       |
| Capture   | Android: screen recording            | :white_check_mark: | :white_check_mark: |                       |
| Capture   | Android: packet capture              | :white_check_mark: | :white_check_mark: | Requires rooted phone |
| Capture   | PCAP: Managed mode on `idt` host     | :white_check_mark: | :white_check_mark: |                       |
| Capture   | PCAP: Monitor mode on `idt` host     | :white_check_mark: | :white_check_mark: |                       |
| Capture   | Thread: Execute sniffer capture      | :white_check_mark: | :x:                | Requires ncp + setup  |
| Capture   | Thread: Execute on-network capture   | :x:                | :x:                | Not implemented       |
| Discovery | BLE                                  | :white_check_mark: | :white_check_mark: |                       |
| Discovery | DNS-SD                               | :white_check_mark: | :white_check_mark: |                       |
| Probe     | Resolve and ping                     | :white_check_mark: | :white_check_mark: |                       |

### Setup support

| Target                 | Supports             | Linux              | MacOS | Description                                  |
| ---------------------- | -------------------- | ------------------ | ----- | -------------------------------------------- |
| `Nrf52840MdkNotDongle` | capture.thread.sniff | :white_check_mark: | :x:   | Setup thread sniffer on Maker diary Nrf52840 |
