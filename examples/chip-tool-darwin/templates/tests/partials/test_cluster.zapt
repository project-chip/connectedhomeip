{{#chip_tests tests useSynthesizeWaitForReport=true}}
class {{filename}}: public TestCommandBridge
{
  public:
    // NOLINTBEGIN(clang-analyzer-nullability.NullPassedToNonnull): Test constructor nullability not enforced
    {{#if ../credsIssuerConfigArg}}
    {{filename}}(CredentialIssuerCommands * credsIssuerConfig): TestCommand("{{filename}}", credsIssuerConfig), mTestIndex(0)
    {{else}}
    {{filename}}(): TestCommandBridge("{{filename}}"), mTestIndex(0)
    {{/if}}
    {
        {{#chip_tests_config}}
          {{#if (isString type)}}
          AddArgument("{{name}}", &m{{asUpperCamelCase name}});
          {{else}}
          AddArgument("{{name}}", {{asTypeMinValue type}}, {{asTypeMaxValue type}}, &m{{asUpperCamelCase name}});
          {{/if}}
        {{/chip_tests_config}}
    }
    // NOLINTEND(clang-analyzer-nullability.NullPassedToNonnull)

    骈戾钺礤ī藻篝蔑眄犷深翦蜴徙鲲殇五粼弩舁秭弪蜷溴萌尚吲乙弦弪萌尚呶线乓蚁一殒ò浇碓弩羯钿屮描轲田缧蝻珧弩蟥汨轲燥镬藻篝郁狎艉骈戾钺礤茴┗殒碓弩裘秕铘浇碓弩羯钿屮描轲田缧蝻珧弩蟥汨轲燥镬藻篝蔑眇戾翦骈戾钺礤茴┗渝裘镯磲钿砒轸郁狒躞萌尚呶线乓蚁药蝈趱蝾揍轸ī蓬篚蝈麇轭泸屙孱碓弩羯钿屮忮骘蝈麇篝狎蝓铑轭翳蝈戾鲠铘泔眄犷洚澡狒麽殒麇祜箦翳糸礤箪殂徭翦麇箦钿翳礤篌徵怩忮骘蝈秕骢钽糸镱汜祆蝈趱蝾蟋麇黠瞌孱躔鏖翳犷轭泔蝌邈碓弩羯钿屮鲠祯镡箦蝣邃麒孱麇珏翳蝈箴镱箦篦轸汨碓弩羯钿屮ｃ栝疬翦篝筮轸屙簖汜箦轭溴描轲田缧蝻珧弩蟥汨轲燥镬藻篝郁屦轭溴灬忮忑茴┗ｉ猩糜殒ㄓ栾蹯溆腴皎Ⅺ猩糜┅五粼弩舁┗蝈趱蝾殒弪藻篝狍震疱蛎犴屐冕箦灬忮忑啕轭溴ī怛遽牖汨轲唪弩趔唛翦眢殒萌尚呶线乓蚁〗弪颟描轲田缗蝌矧ㄣ栝鹪镲飕藻篝漆殪躜搴ン茴汨轲汉膨蝻蛴趄ㄥ蝌┅渝裘镯磲钿砒轸郁狒躞ㄥ蝌┗汨轲汉御篝屙汉渺镢牒涸轫屣豸清糇衢裟躜狒轱瞑泔铙秭弪蜷溴蝈趱蝾汨轲汉御篝屙汉渺镢牒河邈镱潴倍碓轫屣豸轴祯逑颞汨轲唪弩趔咩镱骈邕珏暨溴驷蹯暨鲠祯Ⅳ轫屣豸┅痱轹狒搴篝浜横麸黹氵蹰铘倍唪碓弩羯钿屮泔铙蹰铘倍唪碓弩裘秕铘麸翎煸弩趔ｃ栝疬翦篝筮泔铈殓汨轲汉橡糸镱犰见汨轲赠疱睇狍震疱蛎犴屐冕箦钺礤汨轲唪弩趔咩镱骈琮ｃ栝疬翦篝筮轸屙簖ｉ狍钽怙镬翦篝渝钿渺躞翦螓疳蝈铘骈戾钺礤啕狍藻篝深溴轭溴啕狍震疱蛎犴屐冕箦泔眄犷潺咂蹯骈祆邃驷祗寤殒ｃ栝疬翦篝筮轸屙唑弩痫铙弩ｃ栝疬翦篝筮轸屙唑弩痫铙暹疳蜥礤翦蝮ｉ筢鲥馏狍镶赍泗轹迕赠疱豉疱沆躞翦螨筢鲥馏殒汨轲唪弩趔唛翦磉蝈箴镱箦唣狎犴弭弪簖汨轲唪弩趔唛翦磉蝈箴镱箦簖＊轭扉铄Ⅲ踱筱蜷忮尼翎冕祆忉汶翦篝啕疳蝈铘骈戾钺礤啕狒趄殁豸妪咭屦矧翦轭扉铄ｉ犰祜汜翦吁怏泸殁迥狒崦犰焘徙臊义箴镱箦柔钿戾呶蹯灬忪篚怏泸殁迥狒崦犰焘徙臊铋旎殒}

    {{#*inline "testCommand"}}Test{{asUpperCamelCase label}}_{{index}}{{/inline}}
    CHIP_ERROR {{>testCommand}}()
    {
        {{#if (isTestOnlyCluster cluster)}}
        {{command}}(
        {{#chip_tests_item_parameters}}
        {{#not_first}}, {{/not_first}}
        {{#*inline "defaultValue"}}{{asTypedLiteral (chip_tests_config_get_default_value definedValue) (chip_tests_config_get_type definedValue)}}{{/inline}}
          {{#if (chip_tests_config_has definedValue)}}
              m{{asUpperCamelCase definedValue}}.HasValue() ? m{{asUpperCamelCase definedValue}}.Value() : {{>defaultValue}}
          {{else}}
          {{#if (isString type)}}@"{{/if}}{{definedValue}}{{#if (isString type)}}"{{/if}}
          {{/if}}
        {{/chip_tests_item_parameters}});
        {{else}}
        CHIPDevice * device = GetConnectedDevice();
        CHIPTest{{asUpperCamelCase cluster}} * cluster = [[CHIPTest{{asUpperCamelCase cluster}} alloc] initWithDevice:device endpoint:{{endpoint}} queue:mCallbackQueue];
        VerifyOrReturnError(cluster != nil, CHIP_ERROR_INCORRECT_STATE);

        {{#if isCommand}}
          {{#if commandObject.arguments.length}}
            __auto_type * params = [[CHIP{{asUpperCamelCase cluster}}Cluster{{asUpperCamelCase command}}Params alloc] init];
          {{/if}}
          {{#chip_tests_item_parameters}}
            {{>test_value target=(concat "params." (asStructPropertyName label)) definedValue=definedValue cluster=parent.cluster depth=0}}
          {{/chip_tests_item_parameters}}
          [cluster {{asLowerCamelCase command}}With{{#if commandObject.arguments.length}}Params:params completionHandler{{else}}CompletionHandler{{/if}}:
          {{#if commandObject.hasSpecificResponse}}
            ^(CHIP{{asUpperCamelCase cluster}}Cluster{{asUpperCamelCase commandObject.responseName}}Params * _Nullable values, NSError * _Nullable err) {
          {{else}}
            ^(NSError * _Nullable err) {
          {{/if}}
        {{else if isSubscribeAttribute}}
          {{#chip_tests_item_parameters}}
            {{asObjectiveCBasicType type}} {{asLowerCamelCase name}}Argument = {{asTypedLiteral definedValue type}};
          {{/chip_tests_item_parameters}}
          CHIPSubscribeParams * params = [[CHIPSubscribeParams alloc] init];
          [cluster subscribeAttribute{{asUpperCamelCase attribute}}WithMinInterval:[NSNumber numberWithUnsignedInt:minIntervalArgument]
                                                                   maxInterval:[NSNumber numberWithUnsignedInt:maxIntervalArgument] 
                                                                   params:params
                                                                   subscriptionEstablished:^{
              VerifyOrReturn(testSendCluster{{parent.filename}}_{{asTestIndex waitForReport.index}}_{{asUpperCamelCase waitForReport.command}}_Fulfilled, SetCommandExitStatus(CHIP_ERROR_INCORRECT_STATE));
              NextTest();
          }
          reportHandler:^({{asObjectiveCClass attributeObject.type cluster forceList=attributeObject.isArray}} * _Nullable value, NSError * _Nullable err) {
        {{else if isWaitForReport}}
          {{> subscribeDataCallback }} = ^({{asObjectiveCClass attributeObject.type cluster forceList=attributeObject.isArray}} * _Nullable value, NSError * _Nullable err) {
        {{else if isReadAttribute}}
        {{#if_is_fabric_scoped_struct attributeObject.type}}
        CHIPReadParams * params = [[CHIPReadParams alloc] init];
        params.fabricFiltered = [NSNumber numberWithBool:true];
        {{/if_is_fabric_scoped_struct}}
        [cluster readAttribute{{asUpperCamelCase attribute}}With
        {{#if_is_fabric_scoped_struct attributeObject.type}}
        Params:params completionHandler:
        {{else}}
        CompletionHandler:
        {{/if_is_fabric_scoped_struct}}
        ^({{asObjectiveCClass attributeObject.type cluster forceList=attributeObject.isArray}} * _Nullable value, NSError * _Nullable err) {
        {{else if isWriteAttribute}}
          {{#chip_tests_item_parameters}}
            id {{asLowerCamelCase name}}Argument;
            {{>test_value target=(concat (asLowerCamelCase name) "Argument") definedValue=definedValue cluster=parent.cluster depth=0}}
          {{/chip_tests_item_parameters}}
          [cluster writeAttribute{{asUpperCamelCase attribute}}WithValue:{{#chip_tests_item_parameters}}{{asLowerCamelCase name}}Argument{{/chip_tests_item_parameters}} completionHandler:^(NSError * _Nullable err) {
        {{/if}}
            NSLog(@"{{label}} Error: %@", err);

            {{#if optional}}
            if (err.code == MatterInteractionErrorCodeUnsupportedAttribute) {
                NextTest();
                return;
            }
            {{/if}}

            {{#chip_tests_item_responses}}
            {{#if error}}
              VerifyOrReturn(CheckValue("status", err, {{error}}));
              NextTest();
            {{else}}
              VerifyOrReturn(CheckValue("status", err, 0));
            {{#unless isSubscribeAttribute}}

            {{#chip_tests_item_response_parameters}}
            {{#*inline "actualValue"}}value{{#unless parent.isAttribute}}s.{{asStructPropertyName name}}{{/unless}}{{/inline}}
            {{#if hasExpectedValue}}
            {
              id actualValue = {{> actualValue}};
              {{>check_test_value actual="actualValue" expected=expectedValue cluster=../cluster}}
            }
            {{/if}}
            {{#if hasExpectedConstraints}}
            {{#*inline "item"}}{{asLowerCamelCase name}}{{/inline}}
            {{#if (hasProperty expectedConstraints "type")}}VerifyOrReturn(CheckConstraintType("{{>item}}", "", "{{expectedConstraints.type}}"));{{/if}}
            {{#if (hasProperty expectedConstraints "format")}}VerifyOrReturn(CheckConstraintFormat("{{>item}}", "", "{{expectedConstraints.format}}"));{{/if}}
            {{#if (hasProperty expectedConstraints "startsWith")}}VerifyOrReturn(CheckConstraintStartsWith("{{>item}}", {{>actualValue}}, "{{expectedConstraints.startsWith}}"));{{/if}}
            {{#if (hasProperty expectedConstraints "endsWith")}}VerifyOrReturn(CheckConstraintEndsWith("{{>item}}", {{>actualValue}}, "{{expectedConstraints.endsWith}}"));{{/if}}
            {{#if (hasProperty expectedConstraints "isUpperCase")}}VerifyOrReturn(CheckConstraintIsUpperCase("{{>item}}", {{>actualValue}}, {{expectedConstraints.isUpperCase}}));{{/if}}
            {{#if (hasProperty expectedConstraints "isLowerCase")}}VerifyOrReturn(CheckConstraintIsLowerCase("{{>item}}", {{>actualValue}}, {{expectedConstraints.isLowerCase}}));{{/if}}
            {{#if (hasProperty expectedConstraints "isHexString")}}VerifyOrReturn(CheckConstraintIsHexString("{{>item}}", {{>actualValue}}, {{expectedConstraints.isHexString}}));{{/if}}
            {{#if (hasProperty expectedConstraints "minLength")}}VerifyOrReturn(CheckConstraintMinLength("{{>item}}", [{{>actualValue}} length], {{expectedConstraints.minLength}}));{{/if}}
            {{#if (hasProperty expectedConstraints "maxLength")}}VerifyOrReturn(CheckConstraintMaxLength("{{>item}}", [{{>actualValue}} length], {{expectedConstraints.maxLength}}));{{/if}}
            {{#if (hasProperty expectedConstraints "minValue")}}
              if ({{>actualValue}} != nil) {
                VerifyOrReturn(CheckConstraintMinValue<{{chipType}}>("{{>item}}", [{{>actualValue}} {{asObjectiveCNumberType "" type true}}Value], {{asTypedLiteral expectedConstraints.minValue type}}));
              }
            {{/if}}
            {{#if (hasProperty expectedConstraints "maxValue")}}
              if ({{>actualValue}} != nil) {
                VerifyOrReturn(CheckConstraintMaxValue<{{chipType}}>("{{>item}}", [{{>actualValue}} {{asObjectiveCNumberType "" type true}}Value], {{asTypedLiteral expectedConstraints.maxValue type}}));
              }
            {{/if}}
            {{#if (hasProperty expectedConstraints "notValue")}}
              {{#if (isLiteralNull expectedConstraints.notValue)}}
              VerifyOrReturn(CheckValueNonNull("{{>item}}", {{>actualValue}}));
              {{else}}
              if ({{>actualValue}} != nil) {
                {{#if (isString type)}}
                VerifyOrReturn(CheckConstraintNotValue("{{>item}}", {{>actualValue}}, {{asTypedLiteral expectedConstraints.notValue type}}));
                {{else}}
                VerifyOrReturn(CheckConstraintNotValue("{{>item}}", {{>actualValue}}, {{asTypedLiteral expectedConstraints.notValue type}}));
                {{/if}}
              }
              {{/if}}
            {{/if}}
        {{/if}}
        {{#if saveAs}}
        {
          {{saveAs}} = {{>actualValue}};
        }
        {{/if}}
        {{/chip_tests_item_response_parameters}}

        {{#unless async}}
        NextTest();
        {{else}}
        testSendCluster{{parent.filename}}_{{asTestIndex ../index}}_{{asUpperCamelCase command}}_Fulfilled = true;
        {{/unless}}
        {{else}}
          {{! We're a subscription }}
          if ({{> subscribeDataCallback}} != nil) {
            ResponseHandler callback = {{> subscribeDataCallback}};
            {{> subscribeDataCallback}} = nil;
            callback(value, err);
          }
        {{/unless}}
        {{/if}}
        {{/chip_tests_item_responses}}
    }{{#unless isWaitForReport}}]{{/unless}};

    {{/if}}
    {{#if async}}
    NextTest();
    {{else}}
    {{#*inline "minCommandTimeout"}}
      {{#if (isTestOnlyCluster cluster)}}
        {{#if (isStrEqual command "WaitForMs")}}
          {{#chip_tests_item_parameters}}{{#if (isStrEqual name "ms")}}({{definedValue}} / 1000) + {{/if}}{{/chip_tests_item_parameters}}
        {{/if}}
      {{/if}}
    {{/inline}}
    {{/if}}
    return CHIP_NO_ERROR;
  }
{{/chip_tests_items}}

};

{{/chip_tests}}
