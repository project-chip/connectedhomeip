# Copyright (c) 2025 Project CHIP Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Darwin Multicast Diagnostic

on:
    push:
        branches:
            - macOS-26-ci-multicast
    pull_request:
        branches:
            - macOS-26-ci-multicast
    workflow_dispatch:

concurrency:
    group: ${{ github.ref }}-${{ github.workflow }}-${{ (github.event_name == 'pull_request' && github.event.number) || (github.event_name == 'workflow_dispatch' && github.run_number) || github.sha }}
    cancel-in-progress: true

env:
    CHIP_NO_LOG_TIMESTAMPS: true

jobs:
    multicast_diagnostic:
        name: Multicast Diagnostic - Darwin

        strategy:
            matrix:
                include:
                    - os: macos-26
                      arch: arm64
                      build_variant: no-ble-no-shell-asan-clang

        env:
            BUILD_VARIANT: ${{matrix.build_variant}}

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Setup Environment
              run: brew install coreutils

            - name: Checkout submodules & Bootstrap
              uses: ./.github/actions/checkout-submodules-and-bootstrap
              with:
                  platform: darwin
                  bootstrap-log-name: bootstrap-logs-darwin-diagnostic

            - name: Create diagnostics directory
              run: mkdir -p diagnostics

            # 1. Firewall and Packet Filter Checks
            - name: Check Firewall and Packet Filter Rules
              run: |
                  echo "=== Packet Filter Rules ===" > diagnostics/firewall.txt
                  sudo pfctl -sr >> diagnostics/firewall.txt 2>&1 || echo "No PF rules" >> diagnostics/firewall.txt

                  echo "" >> diagnostics/firewall.txt
                  echo "=== PF NAT Rules ===" >> diagnostics/firewall.txt
                  sudo pfctl -sn >> diagnostics/firewall.txt 2>&1 || echo "No NAT rules" >> diagnostics/firewall.txt

                  echo "" >> diagnostics/firewall.txt
                  echo "=== PF Status/Info ===" >> diagnostics/firewall.txt
                  sudo pfctl -si >> diagnostics/firewall.txt 2>&1 || echo "PF disabled?" >> diagnostics/firewall.txt

                  echo "" >> diagnostics/firewall.txt
                  echo "=== Application Firewall State ===" >> diagnostics/firewall.txt
                  sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate >> diagnostics/firewall.txt 2>&1

                  echo "" >> diagnostics/firewall.txt
                  echo "=== Application Firewall Apps ===" >> diagnostics/firewall.txt
                  sudo /usr/libexec/ApplicationFirewall/socketfilterfw --listapps >> diagnostics/firewall.txt 2>&1

                  cat diagnostics/firewall.txt

            # 2. Network Interface and Multicast Group Info
            - name: Check Network Interfaces and Multicast Groups
              run: |
                  echo "=== All Interfaces ===" > diagnostics/network.txt
                  ifconfig -a >> diagnostics/network.txt

                  echo "" >> diagnostics/network.txt
                  echo "=== IPv6 Multicast Groups ===" >> diagnostics/network.txt
                  netstat -g -f inet6 >> diagnostics/network.txt

                  echo "" >> diagnostics/network.txt
                  echo "=== IPv6 Routing Table ===" >> diagnostics/network.txt
                  netstat -rn -f inet6 >> diagnostics/network.txt

                  cat diagnostics/network.txt

            # 3. Build test apps
            - name: Build Test Apps
              run: |
                  ./scripts/run_in_build_env.sh \
                   "./scripts/build/build_examples.py \
                      --target darwin-${{matrix.arch}}-all-clusters-${BUILD_VARIANT} \
                      --target darwin-${{matrix.arch}}-chip-tool-${BUILD_VARIANT} \
                      build \
                      --copy-artifacts-to objdir-clone \
                   "

            # 4. Start app and trace syscalls during test
            - name: Run Test with Syscall Tracing
              run: |
                  # Start chip-all-clusters-app in background
                  ./objdir-clone/darwin-${{matrix.arch}}-all-clusters-${BUILD_VARIANT}/chip-all-clusters-app \
                    --discriminator 3840 \
                    > diagnostics/app.log 2>&1 &
                  APP_PID=$!
                  echo "Started app with PID: $APP_PID"

                  # Give app time to start
                  sleep 5

                  # Start syscall tracing
                  echo "Starting dtruss on PID $APP_PID"
                  sudo dtruss -t sendto,setsockopt,bind,socket -p $APP_PID > diagnostics/syscall-trace.txt 2>&1 &
                  TRACE_PID=$!

                  # Give tracing time to attach
                  sleep 2

                  # Run the test (just Test_TC_SC_5_2)
                  ./scripts/run_in_build_env.sh \
                  "./scripts/tests/run_test_suite.py \
                     --runner chip_tool_python \
                     --chip-tool ./objdir-clone/darwin-${{matrix.arch}}-chip-tool-${BUILD_VARIANT}/chip-tool \
                     --target-glob 'Test_TC_SC_5_2' \
                     run \
                     --iterations 1 \
                     --test-timeout-seconds 120 \
                     --all-clusters-app ./objdir-clone/darwin-${{matrix.arch}}-all-clusters-${BUILD_VARIANT}/chip-all-clusters-app \
                  " > diagnostics/test-output.txt 2>&1 || echo "Test failed (expected)" >> diagnostics/test-output.txt

                  # Stop tracing
                  echo "Stopping dtruss"
                  sudo kill $TRACE_PID 2>/dev/null || true
                  sleep 1

                  # Stop app
                  echo "Stopping app"
                  kill $APP_PID 2>/dev/null || true

                  echo "Test run complete"

            # 5. Collect network state after test
            - name: Check Network State After Test
              if: always()
              run: |
                  echo "=== IPv6 Multicast Groups After Test ===" > diagnostics/network-post-test.txt
                  netstat -g -f inet6 >> diagnostics/network-post-test.txt

                  cat diagnostics/network-post-test.txt

            # 6. Upload all diagnostics
            - name: Upload Diagnostics
              uses: actions/upload-artifact@v5
              if: always()
              with:
                  name: multicast-diagnostics-darwin-${{ matrix.build_variant }}
                  path: diagnostics/
                  retention-days: 7
                  if-no-files-found: error
