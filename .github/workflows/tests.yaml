# Copyright (c) 2020-2021 Project CHIP Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Debug Darwin YAML tests failure

on:
    push:
    workflow_dispatch:

env:
    CHIP_NO_LOG_TIMESTAMPS: true

jobs:
    test_suites_darwin:
        name: Test Suites - Darwin

        strategy:
            matrix:
                include:
                    - os: macos-14
                      arch: arm64     # observed, not configured
                      build_variant: no-ble-no-shell-asan-clang
        env:
            BUILD_VARIANT: ${{matrix.build_variant}}
            CHIP_TOOL_VARIANT: ${{matrix.chip_tool}}
            TSAN_OPTIONS: "halt_on_error=1"
            LSAN_OPTIONS: detect_leaks=1 suppressions=scripts/tests/chiptest/lsan-mac-suppressions.txt

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout
              uses: actions/checkout@v5
            - name: Setup Environment
              # coreutils for stdbuf
              run: brew install coreutils
            - name: Try to ensure the directories for core dumping and diagnostic
                  log collection exist and we can write them.
              run: |
                  sudo chown ${USER} /cores || true
                  mkdir -p ~/Library/Logs/DiagnosticReports || true
                  mkdir objdir-clone || true
            - name: Checkout submodules & Bootstrap
              uses: ./.github/actions/checkout-submodules-and-bootstrap
              with:
                  platform: darwin
                  bootstrap-log-name: bootstrap-logs-darwin-${{ matrix.build_variant }}${{ matrix.chip_tool }}

            # - name: Build Apps
            #   run: |
            #       ./scripts/run_in_build_env.sh \
            #          "./scripts/build/build_examples.py \
            #             --target darwin-${{matrix.arch}}-chip-tool${CHIP_TOOL_VARIANT}-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-all-clusters-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-lock-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-ota-provider-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-ota-requestor-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-tv-app-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-bridge-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-lit-icd-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-microwave-oven-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-rvc-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-network-manager-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-energy-gateway-${BUILD_VARIANT} \
            #             --target darwin-${{matrix.arch}}-energy-management-${BUILD_VARIANT} \
            #             build \
            #             --copy-artifacts-to objdir-clone \
            #          "

            - name: Build Apps
              run: |
                  ./scripts/run_in_build_env.sh \
                     "./scripts/build/build_examples.py \
                        --target darwin-${{matrix.arch}}-chip-tool${CHIP_TOOL_VARIANT}-${BUILD_VARIANT} \
                        --target darwin-${{matrix.arch}}-all-clusters-${BUILD_VARIANT} \
                        --target darwin-${{matrix.arch}}-lock-${BUILD_VARIANT} \
                        build \
                        --copy-artifacts-to objdir-clone \
                     "

            - name: Run Tests using the python parser sending commands to chip-tool
              # tests that failed macOS 15/26 last check: TestGroupMessaging,Test_TC_ACE_1_6,Test_TC_G_*,Test_TC_GRPKEY_*,Test_TC_S_*
              run: |
                  ./scripts/run_in_build_env.sh \
                  "./scripts/tests/run_test_suite.py \
                     --log-level DEBUG \
                     --target TestSystemCommands \
                     --runner chip_tool_python \
                     --chip-tool ./out/darwin-${{matrix.arch}}-chip-tool${CHIP_TOOL_VARIANT}-${BUILD_VARIANT}/chip-tool \
                     --target-skip-glob '{Test_TC_DGTHREAD_2_1,Test_TC_DGTHREAD_2_2,Test_TC_DGTHREAD_2_3,Test_TC_DGTHREAD_2_4}' \
                     run \
                     --iterations 1 \
                     --test-timeout-seconds 120 \
                     --all-clusters-app ./out/darwin-${{matrix.arch}}-all-clusters-${BUILD_VARIANT}/chip-all-clusters-app \
                     --lock-app ./out/darwin-${{matrix.arch}}-lock-${BUILD_VARIANT}/chip-lock-app \
                     --ota-provider-app ./out/darwin-${{matrix.arch}}-ota-provider-${BUILD_VARIANT}/chip-ota-provider-app \
                     --ota-requestor-app ./out/darwin-${{matrix.arch}}-ota-requestor-${BUILD_VARIANT}/chip-ota-requestor-app \
                     --tv-app ./out/darwin-${{matrix.arch}}-tv-app-${BUILD_VARIANT}/chip-tv-app \
                     --bridge-app ./out/darwin-${{matrix.arch}}-bridge-${BUILD_VARIANT}/chip-bridge-app \
                     --lit-icd-app ./out/darwin-${{matrix.arch}}-lit-icd-${BUILD_VARIANT}/lit-icd-app \
                     --microwave-oven-app ./out/darwin-${{matrix.arch}}-microwave-oven-${BUILD_VARIANT}/chip-microwave-oven-app \
                     --rvc-app ./out/darwin-${{matrix.arch}}-rvc-${BUILD_VARIANT}/chip-rvc-app \
                     --network-manager-app ./out/darwin-${{matrix.arch}}-network-manager-${BUILD_VARIANT}/matter-network-manager-app \
                     --energy-gateway-app ./out/darwin-${{matrix.arch}}-energy-gateway-${BUILD_VARIANT}/chip-energy-gateway-app \
                     --energy-management-app ./out/darwin-${{matrix.arch}}-energy-management-${BUILD_VARIANT}/chip-energy-management-app \
                  "

            - name: Run purposeful failure tests using the python parser sending commands to chip-tool
              run: |
                  ./scripts/run_in_build_env.sh \
                  "./scripts/tests/run_test_suite.py \
                     --runner chip_tool_python \
                     --include-tags PURPOSEFUL_FAILURE \
                     --chip-tool ./out/darwin-${{matrix.arch}}-chip-tool${CHIP_TOOL_VARIANT}-${BUILD_VARIANT}/chip-tool \
                     run \
                     --iterations 1 \
                     --expected-failures 3 \
                     --keep-going \
                     --test-timeout-seconds 120 \
                     --all-clusters-app ./out/darwin-${{matrix.arch}}-all-clusters-${BUILD_VARIANT}/chip-all-clusters-app \
                  "

            - name: Uploading core files
              uses: actions/upload-artifact@v5
              if: ${{ failure() && !env.ACT }}
              with:
                  name: crash-core-darwin-${{ matrix.build_variant }}${{ matrix.chip_tool }}
                  path: /cores/
                  # Cores are big; don't hold on to them too long.
                  retention-days: 5
            - name: Uploading diagnostic logs
              uses: actions/upload-artifact@v5
              if: ${{ failure() && !env.ACT }}
              with:
                  name: crash-log-darwin-${{ matrix.build_variant }}${{ matrix.chip_tool }}
                  path: ~/Library/Logs/DiagnosticReports/
            - name: Uploading objdir for debugging
              uses: actions/upload-artifact@v5
              if: ${{ failure() && !env.ACT }}
              with:
                  name: crash-objdir-darwin-${{ matrix.build_variant }}${{ matrix.chip_tool }}
                  path: objdir-clone/
                  # objdirs are big; don't hold on to them too long.
                  retention-days: 5

    repl_tests_linux:
        name: REPL Tests - Linux

        if: github.actor != 'restyled-io[bot]'

        strategy:
            matrix:
                build_variant: [ipv6only-no-ble-no-wifi]

        env:
            TSAN_OPTIONS: "halt_on_error=1 suppressions=scripts/tests/chiptest/tsan-linux-suppressions.txt"
            BUILD_VARIANT: ${{matrix.build_variant}}
            DISABLE_CCACHE: ${{ (github.event_name == 'workflow_dispatch' && inputs.disable_ccache == 'true') && 'true' || (contains(github.event.head_commit.message, '[no-ccache]') && 'true') || 'false' }}
            CCACHE_KEY_SUFFIX: ${{ github.event_name == 'workflow_dispatch' && inputs.cache_suffix || '' }}

        runs-on: ubuntu-latest

        container:
            image: ghcr.io/project-chip/chip-build:174
            options: >-
                --privileged
                --sysctl net.ipv6.conf.all.disable_ipv6=0
                --sysctl net.ipv4.conf.all.forwarding=0
                --sysctl net.ipv6.conf.all.forwarding=0

        steps:
            - name: Checkout
              uses: actions/checkout@v5
            - name: Checkout submodules & Bootstrap
              uses: ./.github/actions/checkout-submodules-and-bootstrap
              with:
                  platform: linux
                  bootstrap-log-name: bootstrap-logs-linux-${{ matrix.build_variant }}${{ matrix.chip_tool }}
            - name: Try to ensure the directories for core dumping exist and we
                  can write them.
              run: |
                  mkdir /tmp/cores || true
                  sysctl -w kernel.core_pattern=/tmp/cores/core.%u.%p.%t || true
                  mkdir objdir-clone || true

            - name: Set up a IPV6 known envionment
              uses: ./.github/actions/add-ipv6

            - name: Setup and Restore Cache
              id: ccache
              uses: ./.github/actions/setup-ccache
              with:
                build-variant: ${{ matrix.build_variant }}
                disable: ${{ env.DISABLE_CCACHE }}
                cache-suffix: ${{ env.CCACHE_KEY_SUFFIX }}

            - name: Build python env
              run: scripts/run_in_build_env.sh './scripts/build_python.sh --install_virtual_env out/venv $([ "${DISABLE_CCACHE}" != "true" ] && echo --enable-ccache)'

            - name: Build apps for REPL tests with unified build
              env:
                  CCACHE_DIR: "${{ github.workspace }}/.ccache"
              run: |
                  ./scripts/run_in_build_env.sh \
                     "./scripts/build/build_examples.py \
                        --target linux-x64-air-purifier-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --target linux-x64-bridge-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --target linux-x64-closure-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --target linux-x64-light-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --target linux-x64-lock-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --target linux-x64-microwave-oven-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --target linux-x64-ota-provider-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --target linux-x64-rvc-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --target linux-x64-thermostat-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --target linux-x64-tv-app-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --target linux-x64-water-leak-detector-${BUILD_VARIANT}-tsan-clang-test-unified \
                        --pw-command-launcher=ccache \
                        build \
                        --copy-artifacts-to objdir-clone \
                     "
                  rm -rf out/unified-build

            - name: Build linux-x64-all-clusters
              env:
                  CCACHE_DIR: "${{ github.workspace }}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-all-clusters-${BUILD_VARIANT}-tsan-clang-test
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-all-clusters-${BUILD_VARIANT}-tsan-clang-test
                  "

            - name: Build linux-x64-lit-icd
              env:
                  CCACHE_DIR: "${{ github.workspace }}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-lit-icd-${BUILD_VARIANT}-tsan-clang-test
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-lit-icd-${BUILD_VARIANT}-tsan-clang-test"

            - name: Build linux-x64-energy-gateway
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-energy-gateway-${BUILD_VARIANT}-tsan-clang-test
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-energy-gateway-${BUILD_VARIANT}-tsan-clang-test"

            - name: Build linux-x64-energy-management
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-energy-management-${BUILD_VARIANT}-tsan-clang-test
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-energy-management-${BUILD_VARIANT}-tsan-clang-test"

            - name: Build linux-x64-network-manager
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-network-manager-${BUILD_VARIANT}-tsan-clang-test
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-network-manager-${BUILD_VARIANT}-tsan-clang-test"

            - name: Build linux-x64-fabric-admin-rpc
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-fabric-admin-rpc-${BUILD_VARIANT}-clang
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-fabric-admin-rpc-${BUILD_VARIANT}-clang"

            - name: Build linux-x64-fabric-bridge-rpc
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-fabric-bridge-rpc-${BUILD_VARIANT}-clang
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-fabric-bridge-rpc-${BUILD_VARIANT}-clang"

            - name: Build linux-x64-fabric-sync
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-fabric-sync-${BUILD_VARIANT}-clang
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-fabric-sync-${BUILD_VARIANT}-clang"

            # TODO: camera app needs clang support
            - name: Build linux-x64-camera
              env:
                  CCACHE_DIR: "${{ github.workspace }}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-camera
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-camera"

            - name: Build linux-x64-camera-controller
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-camera-controller
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-camera-controller"

            - name: Build linux-x64-light-data-model-no-unique-id
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-light-data-model-no-unique-id-${BUILD_VARIANT}-clang
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-light-data-model-no-unique-id-${BUILD_VARIANT}-clang"

            - name: Build linux-x64-terms-and-conditions
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-terms-and-conditions
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-terms-and-conditions"

            - name: Build linux-x64-python-bindings
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-python-bindings-webrtc
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-python-bindings-webrtc"

            - name: Build linux-x64-jf-control-app
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-jf-control-app
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-jf-control-app"

            - name: Build linux-x64-jf-admin-app
              env:
                  CCACHE_DIR: "${GITHUB_WORKSPACE}/.ccache"
              run: >-
                  ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py
                  --target linux-x64-jf-admin-app
                  --pw-command-launcher=ccache build --copy-artifacts-to objdir-clone
                  && rm -rf out/linux-x64-jf-admin-app"

            - name: ccache stats
              run: ccache -s

            - name: Install push_av_server dependencies
              run: >-
                  ./scripts/run_in_python_env.sh out/venv \
                  "python3 -m pip install -r src/tools/push_av_server/requirements.txt \
                    && patch -d \$(python3 -m pip show hypercorn | grep 'Location: ' | sed 's/Location: //') -p0 < src/tools/push_av_server/hypercorn.patch \
                  "

            - name: Generate an argument environment file
              run: |
                  echo -n "" >/tmp/test_env.yaml
                  echo "ALL_CLUSTERS_APP: objdir-clone/linux-x64-all-clusters-${BUILD_VARIANT}-tsan-clang-test/chip-all-clusters-app" >> /tmp/test_env.yaml
                  echo "BRIDGE_APP: objdir-clone/linux-x64-bridge-${BUILD_VARIANT}-tsan-clang-test-unified/chip-bridge-app" >> /tmp/test_env.yaml
                  echo "CHIP_LOCK_APP: objdir-clone/linux-x64-lock-${BUILD_VARIANT}-tsan-clang-test-unified/chip-lock-app" >> /tmp/test_env.yaml
                  echo "CAMERA_APP: objdir-clone/linux-x64-camera/chip-camera-app" >> /tmp/test_env.yaml
                  echo "CAMERA_CONTROLLER_APP: objdir-clone/linux-x64-camera-controller/chip-camera-controller" >> /tmp/test_env.yaml
                  echo "ENERGY_MANAGEMENT_APP: objdir-clone/linux-x64-energy-management-${BUILD_VARIANT}-tsan-clang-test/chip-energy-management-app" >> /tmp/test_env.yaml
                  echo "ENERGY_GATEWAY_APP: objdir-clone/linux-x64-energy-gateway-${BUILD_VARIANT}-tsan-clang-test/chip-energy-gateway-app" >> /tmp/test_env.yaml
                  echo "LIT_ICD_APP: objdir-clone/linux-x64-lit-icd-${BUILD_VARIANT}-tsan-clang-test/lit-icd-app" >> /tmp/test_env.yaml
                  echo "AIR_PURIFIER_APP: objdir-clone/linux-x64-air-purifier-${BUILD_VARIANT}-tsan-clang-test-unified/chip-air-purifier-app" >> /tmp/test_env.yaml
                  echo "CHIP_MICROWAVE_OVEN_APP: objdir-clone/linux-x64-microwave-oven-${BUILD_VARIANT}-tsan-clang-test-unified/chip-microwave-oven-app" >> /tmp/test_env.yaml
                  echo "CHIP_RVC_APP: objdir-clone/linux-x64-rvc-${BUILD_VARIANT}-tsan-clang-test-unified/chip-rvc-app" >> /tmp/test_env.yaml
                  echo "NETWORK_MANAGEMENT_APP: objdir-clone/linux-x64-network-manager-${BUILD_VARIANT}-tsan-clang-test/matter-network-manager-app" >> /tmp/test_env.yaml
                  echo "FABRIC_ADMIN_APP: objdir-clone/linux-x64-fabric-admin-rpc-${BUILD_VARIANT}-clang/fabric-admin" >> /tmp/test_env.yaml
                  echo "FABRIC_BRIDGE_APP: objdir-clone/linux-x64-fabric-bridge-rpc-${BUILD_VARIANT}-clang/fabric-bridge-app" >> /tmp/test_env.yaml
                  echo "FABRIC_SYNC_APP: objdir-clone/linux-x64-fabric-sync-${BUILD_VARIANT}-clang/fabric-sync" >> /tmp/test_env.yaml
                  echo "LIGHTING_APP_NO_UNIQUE_ID: objdir-clone/linux-x64-light-data-model-no-unique-id-${BUILD_VARIANT}-clang/chip-lighting-app" >> /tmp/test_env.yaml
                  echo "TERMS_AND_CONDITIONS_APP: objdir-clone/linux-x64-terms-and-conditions/chip-terms-and-conditions-app" >> /tmp/test_env.yaml
                  echo "TRACE_APP: out/trace_data/app-{SCRIPT_BASE_NAME}" >> /tmp/test_env.yaml
                  echo "JF_CONTROL_APP: objdir-clone/linux-x64-jf-control-app/jfc-app" >> /tmp/test_env.yaml
                  echo "JF_ADMIN_APP: objdir-clone/linux-x64-jf-admin-app/jfa-app" >> /tmp/test_env.yaml
                  echo "CLOSURE_APP: objdir-clone/linux-x64-closure-${BUILD_VARIANT}-tsan-clang-test-unified/closure-app" >> /tmp/test_env.yaml
                  echo "WATER_LEAK_DETECTOR_APP: objdir-clone/linux-x64-water-leak-detector-${BUILD_VARIANT}-tsan-clang-test-unified/water-leak-detector-app" >> /tmp/test_env.yaml
                  echo "PUSH_AV_SERVER: src/tools/push_av_server/server.py" >> /tmp/test_env.yaml

                  # Generic trace setups after applications
                  echo "TRACE_TEST_JSON: out/trace_data/test-{SCRIPT_BASE_NAME}" >> /tmp/test_env.yaml
                  echo "TRACE_TEST_PERFETTO: out/trace_data/test-{SCRIPT_BASE_NAME}" >> /tmp/test_env.yaml

            - name: Verify Testing Support
              run: |
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/test_IDM_10_4.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/test_TC_ICDM_2_1_full_pics.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/test_TC_ICDM_2_1_min_pics.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/test_TC_SC_7_1.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestDecorators.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestChoiceConformanceSupport.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestConformanceSupport.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestConformanceTest.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestDefaultWarnings.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestIdChecks.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestMatterTestingSupport.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestPics.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestSpecParsingDataType.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestSpecParsingDeviceType.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestSpecParsingNamespace.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestSpecParsingSelection.py'
                  scripts/run_in_python_env.sh out/venv 'python3 src/python_testing/test_testing/TestSpecParsingSupport.py'
                  scripts/run_in_python_env.sh out/venv 'PYTHONPATH=src/python_testing:$PYTHONPATH python3 -m unittest discover -s src/python_testing/mdns_discovery/tests -p "test_*.py"'

            - name: Run Tests
              run: |
                  mkdir -p out/trace_data
                  scripts/run_in_python_env.sh out/venv 'scripts/tests/run_python_test.py --load-from-env /tmp/test_env.yaml --script src/controller/python/tests/scripts/mobile-device-test.py'
                  scripts/run_in_python_env.sh out/venv 'src/python_testing/execute_python_tests.py --env-file /tmp/test_env.yaml --search-directory src/python_testing'
                  scripts/run_in_python_env.sh out/venv "scripts/tests/TestTimeSyncTrustedTimeSourceRunner.py --all-clusters objdir-clone/linux-x64-all-clusters-${BUILD_VARIANT}-tsan-clang-test/chip-all-clusters-app"

            - name: Execute Jupyter Notebooks
              run: |
                  scripts/run_in_build_env.sh './scripts/build_python.sh --jupyter-lab --install_virtual_env out/venv'
                  ./scripts/run_in_build_env.sh \
                   "./scripts/build/build_examples.py \
                      --target linux-x64-all-clusters-${BUILD_VARIANT}-clang-test \
                      build \
                      --copy-artifacts-to objdir-clone \
                   "
                  # TODO: ipynb HARD CODES paths to all-clusters app. create a symlink to them
                  ln -s linux-x64-all-clusters-${BUILD_VARIANT}-clang-test out/linux-x64-all-clusters

                  scripts/run_in_python_env.sh out/venv \
                  "jupyter execute docs/development_controllers/matter-repl/Matter_REPL_Intro.ipynb \
                  docs/development_controllers/matter-repl/Matter_Basic_Interactions.ipynb \
                  docs/development_controllers/matter-repl/Matter_Access_Control.ipynb \
                  docs/development_controllers/matter-repl/Matter_Multi_Fabric_Commissioning.ipynb \
                  "

            - name: Uploading core files
              uses: actions/upload-artifact@v5
              if: ${{ failure() && !env.ACT }}
              with:
                  name: crash-core-linux-python-repl
                  path: /tmp/cores/
                  # Cores are big; don't hold on to them too long.
                  retention-days: 5
            - name: Uploading objdir for debugging
              uses: actions/upload-artifact@v5
              if: ${{ failure() && !env.ACT }}
              with:
                  name: crash-objdir-linux-python-repl
                  path: objdir-clone/
                  # objdirs are big; don't hold on to them too long.
                  retention-days: 5
            - name: Delete existing ccache before save
              if: github.ref == 'refs/heads/master' && env.DISABLE_CCACHE != 'true'
              uses: ./.github/actions/delete-cache
              with:
                  cache-key: ${{ env.CCACHE_KEY }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}
            - name: Save ccache
              if: github.ref == 'refs/heads/master' && env.DISABLE_CCACHE != 'true'
              uses: actions/cache/save@v4
              with:
                  path: .ccache
                  key: ${{ env.CCACHE_KEY }}

    repl_tests_darwin:
        name: REPL Tests - Darwin (Build Only)

        strategy:
            matrix:
                include:
                - os: macos-14
                  arch: arm64   # observed, not configured
                  build_variant: no-ble-no-wifi-tsan-clang
                # - os: macos-15-intel
                #   arch: x64   # observed, not configured
                #   build_variant: no-ble-no-wifi-tsan-clang`
                # - os: macos-15
                #   arch: arm64   # observed, not configured
                #   build_variant: no-ble-no-wifi-tsan-clang`
        env:
            BUILD_VARIANT: ${{matrix.build_variant}}
            TSAN_OPTIONS: "halt_on_error=1"

        if: github.actor != 'restyled-io[bot]'
        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout
              uses: actions/checkout@v5
            - name: Setup Environment
              # coreutils for stdbuf
              run: brew install coreutils
            - name: Try to ensure the directories for core dumping and diagnostic
                  log collection exist and we can write them.
              run: |
                  sudo chown ${USER} /cores || true
                  mkdir -p ~/Library/Logs/DiagnosticReports || true
                  mkdir objdir-clone || true
            - name: Checkout submodules & Bootstrap
              uses: ./.github/actions/checkout-submodules-and-bootstrap
              with:
                  platform: darwin
                  bootstrap-log-name: bootstrap-logs-darwin-${{ matrix.build_variant }}${{ matrix.chip_tool }}

            - name: Build Python REPL and example apps
              run: |
                  scripts/run_in_build_env.sh './scripts/build_python.sh --install_virtual_env out/venv'
                  ./scripts/run_in_build_env.sh \
                   "./scripts/build/build_examples.py \
                      --target darwin-${{matrix.arch}}-all-clusters-${BUILD_VARIANT}-test \
                      build \
                      --copy-artifacts-to objdir-clone \
                   "
            - name: Run Tests
              if: false # disable darwin test runs for now as they were very flaky in the past
              run: |
                  scripts/run_in_python_env.sh out/venv './scripts/tests/run_python_test.py --app out/darwin-${{matrix.arch}}-all-clusters-no-ble-no-wifi-tsan-clang-test/chip-all-clusters-app --factory-reset --quiet --app-args "--discriminator 3840 --interface-id -1" --script-args "-t 3600 --disable-test ClusterObjectTests.TestTimedRequestTimeout"'
            - name: Uploading core files
              uses: actions/upload-artifact@v5
              if: ${{ failure() && !env.ACT }}
              with:
                  name: crash-core-darwin-python-repl
                  path: /cores/
                  # Cores are big; don't hold on to them too long.
                  retention-days: 5
            - name: Uploading traces on failure
              uses: actions/upload-artifact@v5
              if: ${{ failure() && !env.ACT }}
              with:
                  name: trace-data-python-repl
                  path: out/trace_data/
                  retention-days: 5
            - name: Uploading diagnostic logs
              uses: actions/upload-artifact@v5
              if: ${{ failure() && !env.ACT }}
              with:
                  name: crash-log-darwin-python-repl
                  path: ~/Library/Logs/DiagnosticReports/
            - name: Uploading objdir for debugging
              uses: actions/upload-artifact@v5
              if: ${{ failure() && !env.ACT }}
              with:
                  name: crash-objdir-darwin-python-repl
                  path: objdir-clone/
                  # objdirs are big; don't hold on to them too long.
                  retention-days: 5
